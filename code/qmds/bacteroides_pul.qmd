---
title: "Using PULs to predict Proteobacteria BSI risk"
engine: knitr
format:
  html:
    code-fold: true
    code-summary: "Show the code"
---


## Defining case and control sets from metagenomic samples

Get a clean list of metagenomic samples (isabl1):
```{sh}
cat misc_files/enterococcus_diversity/all_target_samples_hostdepleted.txt | sed "s/\[\('\([^']*\)'\)\]/\2/" | sed '$d' > misc_files/bacteroides_pul/isabl1_samples.txt
```

Now, let's figure which patients have metagenomic samples within a certain period (7, 14, and 30 days) before a proteobacteria BSI:

```{r}
# Load required libraries and functions
suppressMessages(library(tidyverse))
source("code/rfunctions/data_helpers.r")

# Load the list of samples with metagenomic sequence
isabl1_samples <- scan("misc_files/bacteroides_pul/isabl1_samples.txt", what = "character")

# Load the table with sample-patient data
tblASVsamples <- read_csv("data/tblASVsamples.csv") %>%
  distinct(SampleID, .keep_all = TRUE) %>%
  mutate(isabl1 = SampleID %in% isabl1_samples) %>%
  select(SampleID, PatientID, DayRelativeToNearestHCT, isabl1)

# Load the patientday table
load("analyses/processed_data/tblpatientday_clinical.RData")
tblpatientday_clinical$DayRelativeToNearestHCT <- as.numeric(as.character(tblpatientday_clinical$DayRelativeToNearestHCT))

# Annorate patientday table with isabl1 isabl1
tblpatientday_isabl1 <- tblpatientday_clinical %>%
  left_join(tblASVsamples, by = c("PatientID" = "PatientID", "DayRelativeToNearestHCT" = "DayRelativeToNearestHCT"))

# Patients with at least one metagenome and a Proteobacteria infection
proteobsi_isabl1_all <- tblpatientday_isabl1 %>%
  group_by(PatientID) %>%
  summarize(
    has_isabl1 = any(isabl1 == TRUE, na.rm = TRUE),
    has_proteo = any(Proteobacteria_infection == 1, na.rm = TRUE)
  ) %>%
  filter(has_isabl1 & has_proteo) %>%
  pull(PatientID) %>%
  sort() %>%
  unique()

# Let's now find the patients with metagenomes within X days of the first Proteo infection

# Find first day of Proteobacteria_infection for each patient
first_proteo <- tblpatientday_isabl1 %>%
  filter(Proteobacteria_infection == 1) %>%
  group_by(PatientID) %>%
  summarize(first_infection_day = min(DayRelativeToNearestHCT, na.rm = TRUE))

# Patients with a metagenome within 7 days before or on the first infection day
proteobsi_isabl1_7day <- tblpatientday_isabl1 %>%
  inner_join(first_proteo, by = "PatientID") %>%
  filter(isabl1 == TRUE,
         DayRelativeToNearestHCT >= (first_infection_day - 7),
         DayRelativeToNearestHCT <= first_infection_day) %>%
  pull(PatientID) %>%
  unique() %>%
  sort()

# Patients with a metagenome within 14 days before or on the first infection day
proteobsi_isabl1_14day <- tblpatientday_isabl1 %>%
  inner_join(first_proteo, by = "PatientID") %>%
  filter(isabl1 == TRUE,
         DayRelativeToNearestHCT >= (first_infection_day - 14),
         DayRelativeToNearestHCT <= first_infection_day) %>%
  pull(PatientID) %>%
  unique() %>%
  sort()

# Patients with a metagenome within 14 days before or on the first infection day
proteobsi_isabl1_20day <- tblpatientday_isabl1 %>%
  inner_join(first_proteo, by = "PatientID") %>%
  filter(isabl1 == TRUE,
         DayRelativeToNearestHCT >= (first_infection_day - 20),
         DayRelativeToNearestHCT <= first_infection_day) %>%
  pull(PatientID) %>%
  unique() %>%
  sort()

# Show patient lists
proteobsi_isabl1_7day
proteobsi_isabl1_14day
proteobsi_isabl1_20day
```

Now, for each set, let's make a matching control set for the statistical analyses:

```{r}
tblrel_genus_meta <- prep_taxa_counts("genus")


#' Create matched case-control dataset for metagenomic samples (Proteobacteria BSI)
#'
#' @param case_patients Vector of PatientIDs for cases
#' @param n_controls Number of controls per case (default 4)
#' @return Data frame with matched case-control samples
create_case_control_data <- function(case_patients, n_controls = 4) {
  # Use objects from the environment: tblASVsamples, tblpatientday_clinical, first_proteo, tblrel_genus_meta, proteobsi_isabl1_all
  
  # Get case samples: nearest metagenome sample before/on first infection
  case_samples <- tblASVsamples %>%
    filter(PatientID %in% case_patients, isabl1 == TRUE) %>%
    inner_join(first_proteo, by = "PatientID") %>%
    mutate(day_diff = first_infection_day - DayRelativeToNearestHCT) %>%
    filter(day_diff >= 0) %>%
    group_by(PatientID) %>%
    slice_min(order_by = day_diff, n = 1, with_ties = FALSE) %>%
    ungroup() %>%
    select(PatientID, SampleID, DayRelativeToNearestHCT, first_infection_day, day_diff)
  
  # Add clinical phase and sex
  case_samples <- case_samples %>%
    left_join(tblpatientday_clinical %>% select(PatientID, DayRelativeToNearestHCT, clinical_phase, sex),
              by = c("PatientID", "DayRelativeToNearestHCT"))
  
  # Prepare control pool: patients with metagenomic samples, no Proteobacteria infection
  control_pool <- tblASVsamples %>%
    filter(isabl1 == TRUE, !PatientID %in% proteobsi_isabl1_all) %>%
    left_join(tblpatientday_clinical %>% select(PatientID, DayRelativeToNearestHCT, clinical_phase, sex, Proteobacteria_infection),
              by = c("PatientID", "DayRelativeToNearestHCT")) %>%
    filter(Proteobacteria_infection == 0 | is.na(Proteobacteria_infection))
  
  # For each case, randomly select n_controls matched by clinical_phase and sex
  set.seed(1830)
  matched_case_controls <- case_samples %>%
    rowwise() %>%
    mutate(
      control_samples = list({
        phase <- clinical_phase
        sex_ref <- sex
        control_pool %>%
          filter(clinical_phase == phase, sex == sex_ref) %>%
          sample_n(size = min(n_controls, n()), replace = FALSE) %>%
          select(PatientID, SampleID, DayRelativeToNearestHCT, clinical_phase, sex)
      })
    ) %>%
    unnest(control_samples, names_sep = "_control") %>%
    ungroup()
  
  # Combine into a single dataset
  case_control_data <- bind_rows(
    case_samples %>%
      mutate(case = TRUE) %>%
      select(PatientID, SampleID, DayRelativeToNearestHCT, clinical_phase, sex, case),
    matched_case_controls %>%
      mutate(case = FALSE) %>%
      select(PatientID = control_samples_controlPatientID,
             SampleID = control_samples_controlSampleID,
             DayRelativeToNearestHCT = control_samples_controlDayRelativeToNearestHCT,
             clinical_phase = control_samples_controlclinical_phase,
             sex = control_samples_controlsex,
             case)
  )
  
  return(case_control_data)
}

casecontrol_7day <- create_case_control_data(n_controls = 4, proteobsi_isabl1_7day)
casecontrol_14day <- create_case_control_data(n_controls = 4, proteobsi_isabl1_14day)
casecontrol_20day <- create_case_control_data(n_controls = 4, proteobsi_isabl1_20day)
```

Let's print the Patient IDs from the matched case-control datasets to send to Isaac for benchmarking

```{r}
casecontrol_7day_patients <- casecontrol_7day$PatientID %>% unique()
casecontrol_14day_patients <- casecontrol_14day$PatientID %>% unique()
casecontrol_20day_patients <- casecontrol_20day$PatientID %>% unique()
writeLines(casecontrol_7day_patients, "misc_files/bacteroides_pul/casecontrol_7day_patients.txt")
writeLines(casecontrol_14day_patients, "misc_files/bacteroides_pul/casecontrol_14day_patients.txt")
writeLines(casecontrol_20day_patients, "misc_files/bacteroides_pul/casecontrol_20day_patients.txt")
```

``

## Quantifying PUL abundance at metagenome scale

I started with the metagenomic assemblies that I generated for the Enterococcus F32 exploration. They are under `analyses/enterococcus_diversity/metagenomes/assembly/metaspades/`, but I will symlink them to a new directory to simplify paths:

```{sh, eval=FALSE}
mkdir -p analyses/bacteroides_pul/metagenomes/assembly
ln -s /data1/xavierj/carlos/bsi_prediction/analyses/enterococcus_diversity/metagenomes/assembly/metaspades /data1/xavierj/carlos/bsi_prediction/analyses/bacteroides_pul/metagenomes/assembly/metaspades
```

Then I obtained CGCs and PUL predictions with DBCAN:

```{sh, eval=FALSE}
sbatch code/scripts/bacteroides_pul/dbcan_isabl1.sh
```

Having the predictions, I ran the pipeline to obtain TPM counts of the CGCs and PULs:

```{sh, eval=FALSE}
sbatch code/scripts/bacteroides_pul/get_pulabund.sh
```

## Carbohydrate degradation potential in gut-microbiome taxa across the tree of life

### PUL predictions across isabl1 MAGs

We'll work with thebins recovered from the isabl1 metagenomes using multi-sample sample binning with VAMB (successfull metaspades assemblies used in enterococcus_diversity_II). Let's symlink the MAG directory:

```{sh}
ln -s /data1/xavierj/carlos/bsi_prediction/analyses/enterococcus_diversity_II/binning/short/isabl1/vamb/multi_bins /data1/xavierj/carlos/bsi_prediction/analyses/bacteroides_pul/mags
```

Now, we run CheckM2 on all the bins:

```{sh}
sbatch code/scripts/bacteroides_pul/checkm2_isabl1.sh
```

With the CheckM results and the GTDB results I obtained for the Enterococcus projects for these bins, we can now select a subset of MAGs on which to do the PUL predictions:

```{r}
# Load the CheckM2 and GTDB reports
gtdb <- read_delim("analyses/enterococcus_diversity_II/binning/short/isabl1/gtdb/gtdbtk.bac120.summary.tsv")
checkm <- read_delim("analyses/bacteroides_pul/checkm2/quality_report.tsv")

# Join the reports, starting with the GTDB which includes only the MAGs from Bacteria and split the classification string
full_report <- left_join(gtdb, checkm, by = c("user_genome" = "Name")) %>%
  separate(classification,
           into = c("domain", "phylum", "class", "order", "family", "genus", "species"),
           sep = ";",
           fill = "right",
           remove = FALSE) %>%
  mutate(across(c(domain, phylum, class, order, family, genus, species),
                ~ sub("^[a-z]__","", .)))

# Get list of MAGs with >90% completion and <10% contamination
nc_mags <- full_report %>%
  filter(Contamination <= 10 & Completeness >= 90 & Contig_N50 >= 50000) %>%
  pull(user_genome) %>%
  unique

write(nc_mags, "analyses/bacteroides_pul/isabl1_nc_mags.txt")
```

By filtering MAGs with >90% completeness and <10% contamination, we en up with 10360 MAGs from 980 species out of 1578 (~62%) of all species detected. All 10 major phyla and ~70-80% of all other taxonomic ranks are represented in this set.

Now, let's predict CGCs and PULs for those selected MAGs:

```{bash, eval=FALSE}
sbatch code/scripts/bacteroides_pul/isabl1_mags_dbcan_1-9999.sh # 6000821
sbatch code/scripts/bacteroides_pul/isabl1_mags_dbcan_10000-10360.sh # 6001620
```

And then predict the signal peptides of the CGC proteins:

```{bash, eval=FALSE}
sbatch code/scripts/bacteroides_pul/isabl1_mags_signalp_1-9999.sh
```

```{r}
library(treeio)
library(ggtree)

bac120_tree <- read.tree("bac120.tree")
```

```{r}
#TRASH


case_patients <- proteobsi_isabl1_7day # or _7day, _20day

case_samples <- tblASVsamples %>%
  filter(PatientID %in% case_patients, isabl1 == TRUE) %>%
  inner_join(first_proteo, by = "PatientID") %>%
  mutate(day_diff = first_infection_day - DayRelativeToNearestHCT) %>%
  filter(day_diff >= 0) %>%
  group_by(PatientID) %>%
  slice_min(order_by = day_diff, n = 1, with_ties = FALSE) %>%
  ungroup() %>%
  select(PatientID, SampleID, DayRelativeToNearestHCT, first_infection_day, day_diff)

# Add clinical phase and sex
case_samples <- case_samples %>%
  left_join(tblpatientday_clinical %>% select(PatientID, DayRelativeToNearestHCT, clinical_phase, sex),
            by = c("PatientID", "DayRelativeToNearestHCT"))

# Prepare control pool: patients with metagenomic samples, no Proteobacteria infection
control_pool <- tblASVsamples %>%
  filter(isabl1 == TRUE, !PatientID %in% proteobsi_isabl1_all) %>%
  left_join(tblpatientday_clinical %>% select(PatientID, DayRelativeToNearestHCT, clinical_phase, sex, Proteobacteria_infection),
            by = c("PatientID", "DayRelativeToNearestHCT")) %>%
  filter(Proteobacteria_infection == 0 | is.na(Proteobacteria_infection))

# For each case, randomly select 4 matched controls by clinical_phase and sex
set.seed(1830)
matched_case_controls <- case_samples %>%
  rowwise() %>%
  mutate(
    control_samples = list({
      phase <- clinical_phase
      sex_ref <- sex
      control_pool %>%
        filter(clinical_phase == phase, sex == sex_ref) %>%
        sample_n(size = min(4, n()), replace = FALSE) %>%
        select(PatientID, SampleID, DayRelativeToNearestHCT, clinical_phase, sex)
    })
  ) %>%
  unnest(control_samples, names_sep = "_control") %>%
  ungroup()

# Combine into a single dataset
case_control_data <- bind_rows(
  case_samples %>%
    mutate(case = TRUE) %>%
    select(PatientID, SampleID, DayRelativeToNearestHCT, clinical_phase, sex, case),
  matched_case_controls %>%
    mutate(case = FALSE) %>%
    select(PatientID = control_samples_controlPatientID,
           SampleID = control_samples_controlSampleID,
           DayRelativeToNearestHCT = control_samples_controlDayRelativeToNearestHCT,
           clinical_phase = control_samples_controlclinical_phase,
           sex = control_samples_controlsex,
           case)
) #%>%
  #left_join(tblrel_genus_meta, by = c("PatientID", "SampleID"))

```