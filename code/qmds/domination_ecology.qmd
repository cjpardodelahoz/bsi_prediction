---
title: "Ecology of *E. faecium* dominations and BSI risk"
engine: knitr
format:
  html:
    code-fold: true
    code-summary: "Show the code"
---

## Exploration

### Are there noticeable microbiome differences among dominated patients who did and did not become infected?

```{r}
# Load required libraries and functions
suppressMessages(library(tidyverse))
source("code/rfunctions/data_helpers.r")

# Prepare genus-level counts
tblrel_genus_meta <- prep_taxa_counts("genus")

# Load table with qPCR data
tblqpcr <- read_csv("data/tblqpcr.csv")

# Summarize patients with Enterococcus dominations and infections
domination_bsi_summary <- tblrel_genus_meta %>%
  group_by(PatientID) %>%
  summarize(
    ever_dominated = any(Enterococcus_abund >= 0.10, na.rm = TRUE),
    ever_infected = any(Enterococcus_infection == TRUE, na.rm = TRUE)
  )

# List of dominated patients
dominated_patients <- domination_bsi_summary %>% 
    filter(ever_dominated == TRUE) %>%
    pull(PatientID)

# Load patient-day table with clinical covariates and filter to dominated patients
load("analyses/processed_data/tblpatientday_clinical.RData")
tblpatientday_clinical_dominated <- tblpatientday_clinical %>%
    filter(PatientID %in% dominated_patients) %>%
    drop_na() %>%
    filter(between(as.numeric(as.character(DayRelativeToNearestHCT)), -9, 30))

# Make a version of the patient day table that includes the microbiome data
tblpatientday_clinicalmicro_dominated <- tblpatientday_clinical_dominated %>%
    mutate(DayRelativeToNearestHCT = as.numeric(as.character(DayRelativeToNearestHCT))) %>%
    left_join(tblrel_genus_meta, by = c("PatientID", "DayRelativeToNearestHCT")) %>%
    mutate(DayRelativeToNearestHCT = as.factor(DayRelativeToNearestHCT)) %>%
    filter(Enterococcus_abund >= 0.1) %>%
    #left_join(tblqpcr, by = c("Sample" = "SampleID")) %>%
    drop_na() #%>%
    #mutate(Enterococcus_abs = Enterococcus_abund * qPCR16S)
```

Let's check whether mucositis is still a good predictor of BSI when we only considered patients with dominations:

```{r}
# Fit logistic regression model
clinical_model <- glm(
    Enterococcus_infection ~ WBCtotal + mucositis_grade + MaxTemperature + DayRelativeToNearestHCT,
    data = tblpatientday_clinical_dominated,
    family = binomial(link = "logit")
)

# Summary of the model
summary(clinical_model)
```

```{r}
# Fit logistic regression model
relabund_model <- glm(
    Enterococcus_infection.x ~ Enterococcus_abund + WBCtotal + mucositis_grade + MaxTemperature + DayRelativeToNearestHCT,
    data = tblpatientday_clinicalmicro_dominated,
    family = binomial(link = "logit")
)

# Summary of the model
summary(relabund_model)
```

```{r}
# 1. Select only columns ending with '_abund' (excluding Enterococcus_abund)
abund_cols <- grep("_abund$", names(tblpatientday_clinicalmicro_dominated), value = TRUE)
abund_cols <- setdiff(abund_cols, "Enterococcus_abund")

# Identify rows to keep (nonzero row sums, complete cases)
row_sums <- rowSums(tblpatientday_clinicalmicro_dominated[, abund_cols], na.rm = TRUE)
keep_rows <- row_sums > 0

# Subset abundance and metadata together
abund_matrix <- tblpatientday_clinicalmicro_dominated[keep_rows, abund_cols]
abund_matrix_norm <- abund_matrix / rowSums(abund_matrix, na.rm = TRUE)
abund_matrix_norm <- abund_matrix_norm[complete.cases(abund_matrix_norm), ]
keep_rows_final <- which(keep_rows)[complete.cases(abund_matrix_norm)]

# Subset infection_status to match
infection_status <- tblpatientday_clinicalmicro_dominated$Enterococcus_infection.y[keep_rows][complete.cases(abund_matrix_norm)]

# 4. Add infection status for plotting
infection_status <- tblpatientday_clinicalmicro_dominated$Enterococcus_infection.y

# 5. Perform NMDS ordination (using vegan)
library(vegan)
set.seed(123)
nmds <- metaMDS(abund_matrix_norm, distance = "bray", k = 2, trymax = 100)

# 6. Prepare data for plotting
nmds_df <- as.data.frame(nmds$points)
nmds_df$InfectionStatus <- infection_status

# 7. Plot NMDS
ggplot(nmds_df, aes(x = MDS1, y = MDS2, color = InfectionStatus)) +
  geom_point(size = 3, alpha = 0.8) +
  labs(title = "NMDS of Microbiome (Enterococcus removed)",
       color = "Infection Status") +
  theme_minimal()
```