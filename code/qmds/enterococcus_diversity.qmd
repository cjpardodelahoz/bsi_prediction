---
title: "Dynamics of *Enterococcus* diversity"
engine: knitr
format:
  html:
    code-fold: true
    code-summary: "Show the code"
---

This is an initial exploration of the dynamics of *Enteroccocus* diversity in the HCT patient population. I have the following goals:

 - Stratify patients with *Enterococcus* dominations between those who did and did not get *Enterococcus* infections.
 - Link 16S ASVs to full-length 16S sequences assembled from metagenomes and the corresponding species identities.
 - Characterize genome-level strain diversity of *Enterococcus* across all samples with metagenomes
 - Determine whether dominating strains of *Enterococcus* colonize before or after hospitalization for HCT
 - Quantify *Enterococcus* strain sharing between patients
 - Quantify *Enterococcus* strain diversity within patients and through time during dominations

 ## Summary of dominations and inections
 
 It is already

```{r}
 # Load required libraries and functions
suppressMessages(library(tidyverse))
source("code/rfunctions/data_helpers.r")

# Prepare genus-level counts
tblrel_genus_meta <- prep_taxa_counts("genus")

# Summarize patients with Enterococcus dominations and infections
summary_data <- tblrel_genus_meta %>%
  group_by(PatientID) %>%
  summarize(
    ever_dominated = any(Enterococcus_abund >= 0.3, na.rm = TRUE),
    ever_infected = any(Enterococcus_infection == TRUE, na.rm = TRUE)
  )

# Prepare data for plotting
plot_summary_data <- summary_data %>%
  mutate(
    domination_status = ifelse(ever_dominated, "Dominated", "Not Dominated"),
    infection_status = ifelse(ever_infected, "Infected", "Not Infected")
  ) %>%
  group_by(domination_status, infection_status) %>%
  summarize(count = n(), .groups = "drop")

# Create the bar plot
ggplot(plot_summary_data, aes(x = domination_status, y = count, fill = infection_status)) +
  geom_bar(stat = "identity", position = "stack") +
  geom_text(aes(label = count), position = position_stack(vjust = 0.5), color = "black") +
  scale_fill_manual(
    values = c("Infected" = "#0D7E2B", "Not Infected" = "gray75")
  ) +
  labs(
    x = "Domination status",
    y = "Number of patients",
    fill = "Infection status"
  ) +
  custom_theme
```

Now,

```{r}
# Load sample metadata
tblASVsamples <- read_csv("data/tblASVsamples.csv")

# Filter for patients who got dominated and infected with at least one AccessionShotgun
dominated_infected <- summary_data %>%
  filter(ever_dominated, ever_infected) %>%
  inner_join(tblASVsamples, by = "PatientID") %>%
  filter(!is.na(AccessionShotgun)) %>%
  pull(PatientID) %>%
  unique()

# Filter for patients who got dominated but not infected with at least one AccessionShotgun
dominated_not_infected <- summary_data %>%
  filter(ever_dominated, !ever_infected) %>%
  inner_join(tblASVsamples, by = "PatientID") %>%
  filter(!is.na(AccessionShotgun)) %>%
  pull(PatientID) %>%
  unique()

# Print the results
dominated_infected
dominated_not_infected
```

 ## Strain-resolved genome diversity

 ### MAG quality filtering

 I compiled the *Enterococcus* MAGs binned as described in the [Exploring *Bacteroides* molecular variation]() section:

 ```{bash, eval=FALSE}
GTDB_FILE="analyses/yan_sd_2022/binning/gtdb/gtdbtk.bac120.summary.tsv"
BIN_DIR="analyses/yan_sd_2022/binning/compiled"
OUTPUT_DIR="analyses/enterococcus_diversity/genomes/mags"

# Create the output directory if it doesn't exist
mkdir -p ${OUTPUT_DIR}

# Extract filenames of bins classified in the family Enterococcaceae and copy them
awk -F'\t' 'NR > 1 && $2 ~ /f__Enterococcaceae/ {print $1}' "${GTDB_FILE}" | while read -r bin_file; do
  full_path="${BIN_DIR}/${bin_file}.fna"
  if [[ -f ${full_path} ]]; then
    cp "${full_path}" "${OUTPUT_DIR}/"
  else
    echo "File ${full_path} not found, skipping..."
  fi
done
```

And then I ran CheckM:

```{bash, eval=FALSE}
sbatch code/scripts/enterococcus_diversity/enterococcus_checkm2.sh #7047406
```